# ISO Configuration Documentation

This directory contains the configuration for building the EndOS live ISO using `archiso`.

## ðŸ“ Directory Structure

```
iso/
â”œâ”€â”€ airootfs/                    # Root filesystem overlay
â”‚   â”œâ”€â”€ etc/                    # System configuration
â”‚   â”‚   â”œâ”€â”€ systemd/system/    # Custom systemd services
â”‚   â”‚   â”œâ”€â”€ sudoers.d/         # Sudo configuration
â”‚   â”‚   â””â”€â”€ greetd/            # Login manager config (disabled)
â”‚   â”œâ”€â”€ home/liveuser/         # Live user home directory
â”‚   â”‚   â””â”€â”€ .zprofile          # Auto-start Hyprland
â”‚   â”œâ”€â”€ root/                  # Root user directory
â”‚   â”œâ”€â”€ usr/local/bin/         # Custom scripts
â”‚   â””â”€â”€ var/                   # Variable data
â”‚       â”œâ”€â”€ cache/wheels/      # Python wheels (generated)
â”‚       â””â”€â”€ local_repo/        # AUR packages (generated)
â”œâ”€â”€ efiboot/                    # EFI boot configuration
â”œâ”€â”€ grub/                       # GRUB configuration
â”œâ”€â”€ syslinux/                   # Syslinux bootloader config
â”œâ”€â”€ base.packages.x86_64        # Core system packages
â”œâ”€â”€ user.packages.x86_64        # User-added packages
â”œâ”€â”€ packages.x86_64             # Combined package list (generated)
â”œâ”€â”€ requirements.txt            # Python dependencies (generated)
â”œâ”€â”€ pacman.conf                 # Pacman configuration
â””â”€â”€ profiledef.sh               # ISO profile definition
```

## ðŸŽ¯ Design Decisions

### Auto-Login System

**Goal**: Boot directly to Hyprland desktop without user interaction.

**Implementation**:
- **getty auto-login**: Configured in `airootfs/etc/systemd/system/getty@tty1.service.d/autologin.conf`
- **greetd disabled**: Symlink removed from `multi-user.target.wants/` to prevent login prompt
- **.zprofile**: Executes `start-hyprland` on login (with SSH detection)

**Why not greetd?**
- greetd intercepts tty1 before getty auto-login
- Adds unnecessary complexity for a live ISO
- Kept installed as fallback, but disabled by default

### Python Virtual Environment Setup

**Goal**: Quickshell requires Python packages in a specific venv.

**Implementation**:
- **Service**: `setup-quickshell-venv.service` runs before getty
- **Offline installation**: Uses pre-built wheels from `/var/cache/wheels/`
- **Package manager**: Uses `uv` (not pip) to match dots-hyprland setup
- **Python version**: Specifically Python 3.12 (required by Pillow)

**Why a systemd service?**
- Runs before user login, ensuring venv is ready
- Fails gracefully with clear error messages
- Can be debugged via `journalctl`

**Why uv instead of pip?**
- Matches the official dots-hyprland installation method
- Faster package installation
- Better dependency resolution

### Offline Package Management

**Goal**: ISO should work completely offline.

**Implementation**:
1. **System packages**: Built/downloaded during ISO build, stored in `local_repo/`
2. **Python wheels**: Pre-compiled during build, cached in `/var/cache/wheels/`
3. **Dotfiles**: Bundled in ISO at `~/dots-hyprland/`

**Build process**:
- `build.sh` downloads official packages via pacman
- AUR packages built from source using makepkg
- Python wheels compiled on build machine (not live ISO)
- All artifacts bundled into ISO

### Package Lists

**Why three package files?**

1. **base.packages.x86_64**: Core Arch ISO packages
   - Maintained manually
   - Includes archiso, bootloaders, system tools
   - Rarely changes

2. **user.packages.x86_64**: User-added packages
   - Custom applications
   - Gaming tools (Steam, etc.)
   - Maintained manually

3. **packages.x86_64**: Combined list (generated)
   - Merged from base + user + dots-hyprland dependencies
   - Auto-generated by `build.sh`
   - **Gitignored** - never commit this file

**Why extract from dots-hyprland?**
- Ensures all dotfiles dependencies are included
- Automatically stays in sync with upstream
- Prevents missing package errors

### SSH and Hyprland Conflict

**Problem**: SSHing into the system caused Hyprland to try starting, which crashed.

**Solution**: Check for `SSH_CONNECTION` in `.zprofile`:
```bash
[[ -z "$SSH_CONNECTION" ]] && exec start-hyprland
```

**Why this approach?**
- Simple and reliable
- Allows SSH debugging without crashes
- Hyprland only starts on console (tty1)

### Local Repository Path

**Problem**: Hardcoded paths break in GitHub Actions.

**Solution**: Use placeholder in `pacman.conf`:
```
Server = file://$PWD/local_repo
```

Then replace with actual path in `build.sh`:
```bash
sed -i "s|Server = file://\$PWD/local_repo|Server = file://${SCRIPT_DIR}/local_repo|g" "$ISO_DIR/pacman.conf"
```

**Why this approach?**
- Works in both local builds and CI
- Pacman.conf can be committed to git
- No environment-specific configuration

### Build Dependencies

**Why install meson, ninja, patchelf?**

Some Python packages (pycairo, pygobject, numpy) don't have pre-built wheels for all platforms. They need to be compiled from source during the build process.

**Where they're used**:
- Build machine: Compile packages into wheels
- Live ISO: Only install pre-built wheels (no compilation)

**Result**: Faster live ISO boot, no build tools needed on live system.

## ðŸ”§ Custom Services

### setup-quickshell-venv.service

**Purpose**: Create and populate Python venv for quickshell

**Runs**: Before getty@tty1 (before user login)

**What it does**:
1. Creates venv at `~/.local/state/quickshell/.venv`
2. Uses `uv venv -p 3.12` to create Python 3.12 environment
3. Installs packages from cached wheels (offline)
4. Sets up environment for quickshell to use

**Why before login?**
- Ensures venv is ready when Hyprland starts
- Fails early with clear error if something is wrong
- User sees working desktop, not errors

### configure-liveuser-groups.service

**Purpose**: Add liveuser to wheel and systemd-journal groups

**Runs**: Before getty@tty1

**What it does**:
```bash
usermod -aG wheel,systemd-journal liveuser
```

**Why needed?**
- **wheel**: Allows sudo access for debugging
- **systemd-journal**: Allows reading system logs
- Improves debugging experience on live ISO

## ðŸ“ Configuration Files

### pacman.conf

**Custom repositories**:
- `[local_repo]`: AUR packages built during ISO creation
- `[multilib]`: 32-bit packages (Steam, Wine, etc.)

**Key settings**:
- `ParallelDownloads = 5`: Faster package installation
- `SigLevel = Optional TrustAll` for local_repo: No signature checking for our packages

### profiledef.sh

**Defines**:
- ISO name and version
- Install mode (live ISO)
- Bootloader configurations
- File permissions for custom files

**File permissions**: Critical for security
```bash
["/etc/sudoers.d/liveuser"]="0:0:440"  # Root-owned, specific permissions
```

## ðŸ› Common Issues

### "No space left on device" during venv setup

**Cause**: Trying to build Python packages from source on live ISO

**Fix**: Ensure `build.sh` compiles all packages to wheels during build

### "Bad file:// URL" for local_repo

**Cause**: `$PWD` placeholder not replaced in pacman.conf

**Fix**: `build.sh` must run sed replacement before mkarchiso

### Quickshell not starting

**Possible causes**:
1. Venv service failed - check `systemctl status setup-quickshell-venv`
2. Missing packages - check `pip list` in venv
3. Environment variable not set - check `$ILLOGICAL_IMPULSE_VIRTUAL_ENV`

## ðŸ”„ Build Process Flow

1. **Clone dots-hyprland** - Get latest configuration
2. **Extract packages** - Parse PKGBUILDs for dependencies
3. **Merge package lists** - Combine base + user + dotfiles
4. **Download packages** - Official repos via pacman
5. **Build AUR packages** - Using makepkg
6. **Create local repo** - Generate package database
7. **Build Python wheels** - Compile with build dependencies
8. **Copy dotfiles** - Place in airootfs
9. **Generate ISO** - Run mkarchiso
10. **Output** - ISO in `out/` directory

## ðŸŽ¨ Customization Guide

### Adding Packages

**System packages**:
```bash
echo "package-name" >> iso/user.packages.x86_64
./build.sh
```

**Python packages**:
```bash
echo "package-name==version" >> iso/requirements.txt
./build.sh
```

### Changing Auto-Start Behavior

Edit `build.sh` function `configure_zprofile()` to modify what runs on login.

### Custom Services

1. Create service file in `iso/airootfs/etc/systemd/system/`
2. Create symlink in appropriate `.wants/` directory
3. Add file permissions to `profiledef.sh`

### Modifying Dotfiles

**Don't edit files in `iso/airootfs/` directly** - they're overwritten by `build.sh`.

Instead:
1. Fork end-4/dots-hyprland
2. Update `REPO_URL` in `build.sh`
3. Rebuild ISO

## ðŸ“š References

- [archiso documentation](https://wiki.archlinux.org/title/Archiso)
- [end-4/dots-hyprland](https://github.com/end-4/dots-hyprland)
- [systemd service documentation](https://www.freedesktop.org/software/systemd/man/systemd.service.html)
