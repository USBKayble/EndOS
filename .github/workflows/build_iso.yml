name: Build EndOS ISO

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - feature/live-iso
    paths:
      - 'RELEASE_NOTES.md'
      - '.github/workflows/build_iso.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    permissions:
      contents: write
    container:
      image: archlinux:latest
      options: --privileged

    steps:
    - name: Install Archiso Tools
      run: |
        pacman -Sy --noconfirm archiso git grub syslinux dosfstools mtools

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Prepare ISO Files
      run: |
        # 1. Start with a clean official 'releng' profile
        cp -r /usr/share/archiso/configs/releng iso-build
        
        # 2. Inject ONLY our custom files into the standard profile
        # Auto-start wrapper
        cp iso/airootfs/root/.zlogin iso-build/airootfs/root/.zlogin
        
        # Archinstall defaults
        cp iso/airootfs/root/config.json iso-build/airootfs/root/config.json
        
        # Setup script (still useful for installing to disk)
        cp setup_arch.sh iso-build/airootfs/root/setup_arch.sh
        
        # 2.5 MERGE Package Lists
        # We append our custom packages to the releng list instead of replacing it.
        # This ensures we keep all bootloader/kernel packages required for the ISO to work.
        cat iso/packages.x86_64 >> iso-build/packages.x86_64
        
        # 2.6 LIVE ENVIRONMENT: Dotfiles
        # Clone end-4 dotfiles directly into /etc/skel so new users (and root) get them.
        git clone --depth 1 https://github.com/end-4/dots-hyprland.git iso-build/airootfs/etc/skel/dots-hyprland
        
        # 3. Branding: Rename ISO to EndOS
        # We modify the official profiledef.sh in-place to avoid breaking boot modes.
        # We modify the official profiledef.sh in-place to avoid breaking boot modes.
        sed -i 's/iso_name="archlinux"/iso_name="EndOS"/' iso-build/profiledef.sh
        sed -i 's/iso_label="ARCH_$(date +%Y%m)"/iso_label="ENDOS_$(date +%Y%m)"/' iso-build/profiledef.sh
        sed -i 's/iso_publisher="Arch Linux <https:\/\/archlinux.org>"/iso_publisher="EndOS <https:\/\/github.com\/USBKayble\/EndOS>"/' iso-build/profiledef.sh
        sed -i 's/iso_application="Arch Linux Live\/Rescue CD"/iso_application="EndOS Live\/Rescue CD"/' iso-build/profiledef.sh

    - name: Build Arch ISO
      run: |
        mkdir -p output
        mkarchiso -v -w /tmp/archiso-work -o output iso-build

    - name: Read Release Notes
      id: release_notes
      run: |
        # Read the file content into a variable, handling newlines
        echo "notes<<EOF" >> $GITHUB_OUTPUT
        cat RELEASE_NOTES.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
      with:
        files: |
          output/*.iso
          setup_arch.sh
        name: EndOS Release ${{ github.run_number }}
        tag_name: v${{ github.run_number }}
        body: ${{ steps.release_notes.outputs.notes }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
