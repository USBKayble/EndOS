name: Build EndOS ISO

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - feature/live-iso
    paths:
      - 'RELEASE_NOTES.md'
      - '.github/workflows/build_iso.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    permissions:
      contents: write
    container:
      image: archlinux:latest
      options: --privileged

    steps:
    - name: 1. Setup Build Environment
      uses: ./.github/actions/setup-env

    - name: 2. Prepare ISO Files
      uses: ./.github/actions/prepare-iso

    - name: 3. Build AUR Packages & Local Repo
      uses: ./.github/actions/build-aur

    - name: 4. Configure ISO
      uses: ./.github/actions/configure-iso

    - name: Build Arch ISO
      run: |
        mkdir -p output
        mkarchiso -v -w /tmp/archiso-work -o output iso-build

    - name: Read Release Notes
      id: release_notes
      run: |
        # Read the file content into a variable, handling newlines
        echo "notes<<EOF" >> $GITHUB_OUTPUT
        cat RELEASE_NOTES.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Rename ISO
      id: rename_iso
      run: |
        ISO_FILE=$(find output -name "*.iso")
        
        # Extract title from RELEASE_NOTES.md (remove '# ', replace space with '-')
        # Sanitize to alphanumeric, dashes, dots
        # Extract title from RELEASE_NOTES.md (find first line starting with '# ')
        RELEASE_TITLE=$(grep -m 1 "^# " RELEASE_NOTES.md | sed 's/^# //g' | tr -s ' ' '-')
        
        # Date string
        DATE_TAG=$(date +'%Y.%m.%d')
        
        NEW_NAME="${RELEASE_TITLE}-${DATE_TAG}.iso"
        
        # Rename original to target name
        mv "$ISO_FILE" "output/$NEW_NAME"
        echo "Renamed ISO to: $NEW_NAME"
        
        # Check size (GitHub Limit is 2GB = 2147483648 bytes)
        # We use strict 1900MB limit to be safe
        FILE_SIZE=$(stat -c%s "output/$NEW_NAME")
        MAX_SIZE=$(( 1900 * 1024 * 1024 ))
        
        if [ "$FILE_SIZE" -gt "$MAX_SIZE" ]; then
            echo "File size ($FILE_SIZE bytes) exceeds limit ($MAX_SIZE bytes). Splitting..."
            
            # Go to output dir to not include path in split filenames
            cwd=$(pwd)
            cd output
            
            # Split into chunks with numeric suffixes (.00, .01)
            # Use -- to prevent filename being interpreted as flags if it starts with dash
            split -b 1900M --numeric-suffixes=00 -- "$NEW_NAME" "$NEW_NAME."
            
            # Remove the original large file
            rm "$NEW_NAME"
            cd "$cwd"
            
            echo "iso_path=output/$NEW_NAME.*" >> $GITHUB_OUTPUT
        else
            echo "File size ($FILE_SIZE bytes) is within limits."
            echo "iso_path=output/$NEW_NAME" >> $GITHUB_OUTPUT
        fi

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feature/live-iso'
      with:
        files: |
          ${{ steps.rename_iso.outputs.iso_path }}
          setup_arch.sh
        name: EndOS Release ${{ github.run_number }}
        tag_name: v${{ github.run_number }}
        body: ${{ steps.release_notes.outputs.notes }}
        prerelease: ${{ github.ref == 'refs/heads/feature/live-iso' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
